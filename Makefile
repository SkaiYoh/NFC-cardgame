.PHONY: clean run preview-run biome-preview-run

CC = gcc
CFLAGS = -Wall -Wextra -O2
LDFLAGS = -lpq -lraylib -lm
MACFLAGS = -I/opt/homebrew/opt/libpq/include -L/opt/homebrew/opt/libpq/lib -I/opt/homebrew/include -L/opt/homebrew/lib

# Source files
SRC_CORE = src/core/game.c
SRC_DATA = src/data/db.c src/data/cards.c
SRC_RENDERING = src/rendering/card_renderer.c src/rendering/tilemap_renderer.c src/rendering/viewport.c src/rendering/sprite_renderer.c src/rendering/biome.c src/rendering/ui.c
SRC_ENTITIES = src/entities/entities.c src/entities/troop.c src/entities/building.c src/entities/projectile.c
SRC_SYSTEMS = src/systems/player.c src/systems/energy.c src/systems/spawn.c src/systems/match.c
SRC_LOGIC = src/logic/card_effects.c src/logic/combat.c src/logic/pathfinding.c src/logic/win_condition.c
SRC_HARDWARE = src/hardware/nfc_reader.c src/hardware/arduino_protocol.c
SRC_LIB = lib/cJSON.c

SOURCES = $(SRC_CORE) $(SRC_DATA) $(SRC_RENDERING) $(SRC_ENTITIES) $(SRC_SYSTEMS) $(SRC_LOGIC) $(SRC_HARDWARE) $(SRC_LIB)

cardgame: $(SOURCES)
	$(CC) $(CFLAGS) $(SOURCES) -o cardgame $(MACFLAGS) $(LDFLAGS)

preview: tools/card_preview.c src/rendering/card_renderer.c lib/cJSON.c
	$(CC) $(CFLAGS) tools/card_preview.c src/rendering/card_renderer.c lib/cJSON.c -o card_preview $(MACFLAGS) -lraylib -lm

# Single-Arduino test: NFC_PORT=/dev/ttyACM0 DB_CONNECTION="..." ./cardgame
run: clean cardgame
	NFC_PORT="/dev/ttyUSB0" DB_CONNECTION="host=localhost port=5432 dbname=appdb user=postgres password=postgres" NFC_PORT_P1="/dev/ttyACM0" NFC_PORT_P2="/dev/ttyACM1" ./cardgame

preview-run: preview
	./card_preview

biome_preview: tools/biome_preview.c src/rendering/tilemap_renderer.c src/rendering/biome.c
	$(CC) $(CFLAGS) tools/biome_preview.c src/rendering/tilemap_renderer.c src/rendering/biome.c -o biome_preview $(MACFLAGS) -lraylib -lm

biome-preview-run: biome_preview
	./biome_preview

card_enroll: tools/card_enroll.c src/data/db.c src/data/cards.c src/hardware/nfc_reader.c src/hardware/arduino_protocol.c lib/cJSON.c
	$(CC) $(CFLAGS) tools/card_enroll.c src/data/db.c src/data/cards.c src/hardware/nfc_reader.c src/hardware/arduino_protocol.c lib/cJSON.c -o card_enroll $(MACFLAGS) -lpq -lm

card-enroll-run: card_enroll
	NFC_PORT="/dev/ttyUSB0" DB_CONNECTION="host=localhost port=5432 dbname=appdb user=postgres password=postgres" ./card_enroll

clean:
	rm -f cardgame card_preview biome_preview card_enroll
